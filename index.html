<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAW - Programa de Combate à Litigância Abusiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Bibliotecas para Geração de Documentos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        svg {
            display: inline;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        .gemini-response p, .gemini-response ul { margin-bottom: 0.75rem; }
        .gemini-response h3 { font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem;}
        .gemini-response-direct { white-space: pre-wrap; font-family: inherit; }
        .gemini-response-direct strong { font-weight: 700; display: block; margin-bottom: 0.5rem; font-size: 1.1em; color: #1f2937;}
        
        /* Animação de pulso verde */
        @keyframes pulse-green {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            70% {
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
        }
        .animate-pulse-green {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO DAS CHAVES DE API ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdgi94wyHts70QES3wJ5TqYfM3CkjKyGA",
            authDomain: "caw-combate-litigancia-abusiva.firebaseapp.com",
            projectId: "caw-combate-litigancia-abusiva",
            storageBucket: "caw-combate-litigancia-abusiva.appspot.com",
            messagingSenderId: "486284516738",
            appId: "1:486284516738:web:f93e70333563fadb62839b",
            measurementId: "G-70MZCTBNKG"
        };
        const GEMINI_API_KEY = "AIzaSyCU5O5CmsjuS0IXW4epjkRHHytfd2sWdJI";
        
        // --- INICIALIZAÇÃO DO FIREBASE ---
        let app;
        try {
            app = firebase.app();
        } catch (e) {
            app = firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- Ícones (SVGs) ---
        const LockClosedIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5"><path fillRule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clipRule="evenodd" /></svg> );
        const UserIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> );
        const LogoutIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> );
        const MenuIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16m-7 6h7" /></svg> );
        const CloseIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg> );
        const SparkleIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10.868 2.884c.321.64.321 1.415 0 2.055L9.43 6.493a1 1 0 101.414 1.414l1.555-1.554a2.945 2.945 0 014.163 4.163l-1.555 1.554a1 1 0 101.414 1.414l1.43-1.43a4.95 4.95 0 00-7.001-7.001L10.868 2.884zM2.94 15.05a4.95 4.95 0 007.001 7.001l1.43-1.43a1 1 0 00-1.414-1.414l-1.555 1.554a2.945 2.945 0 01-4.163-4.163l1.555-1.554a1 1 0 00-1.414-1.414l-1.43 1.43z" clipRule="evenodd" /></svg> );
        const SearchIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> );
        const UploadIcon = () => ( <svg className="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4 4-4-4h3V3h2v8z" /></svg> );
        const ChevronDownIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg> );
        const ChevronUpIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>);
        const GavelIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>);
        const ExternalLinkIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg> );
        const DownloadIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> );
        const GoogleIcon = () => (<svg className="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,36.43,44,30.631,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>);
        const ArrowLeftOnRectangleIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>);
        const ArrowRightOnRectangleIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H12" /></svg>);

        // --- Estrutura de Ícones e Módulos ---
        const moduleIcons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            Overview: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            AnáliseDeDados: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            DetecçãoDeFraudes: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            VerificaçãoDeDocs: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            AutomaçãoDeDefesa: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1V4z" /></svg>,
            AntiDesistencia: () => <GavelIcon />,
            GestãoDeRiscos: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            SituaçãoDoExAdverso: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
            CentralDeRelatorios: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-4m3 4v-2m3 2v-6M5 21h14a2 2 0 002-2V7l-4-4H5a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
        };

        const modules = [
            { id: 'Dashboard', name: 'Dashboard', icon: moduleIcons.Dashboard },
            { id: 'Overview', name: 'Overview', icon: moduleIcons.Overview },
            { id: 'AnáliseDeDados', name: 'Análise de Dados', icon: moduleIcons.AnáliseDeDados },
            { id: 'DetecçãoDeFraudes', name: 'Detecção de Fraudes', icon: moduleIcons.DetecçãoDeFraudes },
            { id: 'VerificaçãoDeDocs', name: 'Verificação de Docs', icon: moduleIcons.VerificaçãoDeDocs },
            { id: 'AutomaçãoDeDefesa', name: 'Automação de Defesa', icon: moduleIcons.AutomaçãoDeDefesa },
            { id: 'AntiDesistencia', name: 'Anti-Desistência', icon: moduleIcons.AntiDesistencia },
            { id: 'GestãoDeRiscos', name: 'Gestão de Riscos', icon: moduleIcons.GestãoDeRiscos },
            { id: 'SituaçãoDoExAdverso', name: 'Situação do Ex-Adverso', icon: moduleIcons.SituaçãoDoExAdverso },
            { id: 'CentralDeRelatorios', name: 'Central de Relatórios', icon: moduleIcons.CentralDeRelatorios },
        ];

        // --- Dados Iniciais Mock ---
        const initialCasesData = [
            { id: 1, caseNumber: "0000245-50.2024.2.00.0501", client: "GRUPO CASAS BAHIA S.A.", defendant: "Diversos Advogados", numJuizo: '', nomeJuizo: 'VARA CÍVEL', comarca: 'N/A', uf: 'RJ', subject: "Pedido de Providências", status: "Em Análise na Corregedoria", riskLevel: "Alto", value: 1000.00, details: { summary: "Pedido de Providências para apurar a prática de litigância predatória por diversos advogados.", indicators: ["Causas de pedir idênticas", "Assédio processual", "Cooptação de clientela", "Concentração de grande volume de demandas"], documents: ["Decisão Corregedoria (Id. 5366780)"] } },
            { id: 2, caseNumber: "0100771-66.2022.5.01.0226", client: "VIA VAREJO S.A.", defendant: "Reclamante Individual", numJuizo: '6', nomeJuizo: 'VARA DO TRABALHO', comarca: 'Nova Iguaçu', uf: 'RJ', subject: "Reclamação Trabalhista", status: "Extinto sem Res. de Mérito", riskLevel: "Crítico", value: 45000.00, details: { summary: "Ação julgada como demanda predatória pela 6ª Vara do Trabalho de Nova Iguaçu.", indicators: ["Identidade de objeto", "Padronização de pedidos", "Alegações genéricas"], documents: ["Sentença 6ª VT NI (Id. 5332454)"] } },
            { id: 3, caseNumber: "1046543-64.2025.8.26.0100", client: "SUL AMÉRICA SERVIÇOS DE SAÚDE S/A", defendant: "Goes Engenharia Ltda", numJuizo: '10', nomeJuizo: 'VARA CÍVEL', comarca: 'São Paulo', uf: 'SP', subject: "Reajuste Contratual Abusivo", status: "Em Andamento", riskLevel: "Médio", value: 208901.88, details: { summary: "Ação cominatória para suspender reajustes por sinistralidade.", indicators: ["Questionamento de reajustes retroativos", "Patrocínio por escritório com alto volume de ações"], documents: ["Contestação Sul América"] } },
            { id: 4, caseNumber: "1057186-81.2025.8.26.0100", client: "SUL AMÉRICA COMPANHIA DE SEGURO SAÚDE", defendant: "Paciente", numJuizo: '5', nomeJuizo: 'VARA CÍVEL', comarca: 'São Paulo', uf: 'SP', subject: "Negativa de Cobertura (TAVI)", status: "Liminar Deferida", riskLevel: "Baixo", value: 350000.00, details: { summary: "Ação para garantir cobertura de procedimento TAVI negado pela operadora.", indicators: ["Demanda baseada em necessidade médica urgente"], documents: ["Relatório Médico", "Decisão de Tutela de Urgência"] } },
        ];
        const initialRiskAnalysisData = { "1":{risks:[{type:"Reputacional",probability:"Alta",impact:"Alto",description:"A alegação de litigância predatória pode gerar publicidade negativa.",mitigation:"Elaborar uma estratégia de comunicação proativa."},{type:"Processual",probability:"Média",impact:"Alto",description:"Risco de a Corregedoria suspender a tramitação de mais de 2.000 processos.",mitigation:"Atuar ativamente no Pedido de Providências com contra-argumentos sólidos."}]},"2":{risks:[{type:"Processual",probability:"Baixa",impact:"Alto",description:"A decisão de extinção por litigância predatória cria um precedente favorável valioso.",mitigation:"Catalogar e disseminar a decisão para toda a equipe jurídica. Utilizar como jurisprudência."}]},"3":{risks:[{type:"Financeiro",probability:"Média",impact:"Alto",description:"Impacto financeiro significativo com a possível restituição de valores.",mitigation:"Preparar defesa técnica robusta, com perícia atuarial demonstrando a correção dos reajustes."},{type:"Processual",probability:"Alta",impact:"Médio",description:"O escritório adverso é conhecido por especialização na área, o que pode prolongar o litígio.",mitigation:"Contratar assistente técnico especializado e focar em precedentes favoráveis."}]},"4":{risks:[{type:"Financeiro",probability:"Alta",impact:"Médio",description:"O custo do procedimento TAVI é elevado e pode incentivar novas ações.",mitigation:"Apresentar junta médica e parecer técnico que justifiquem a negativa com base em critérios da ANS."}]} };
        const cnjIndicators = [ { id: 'g', title: "Ações com Petições Genéricas", description: "Distribuição de ações semelhantes com petições genéricas, mascarando a realidade dos fatos.", cpc: "art. 80, II e V, CPC" }, { id: 'l', title: "Concentração de Demandas", description: "Concentração de grande volume de demandas em poucos profissionais.", cpc: "art. 80, III e V, CPC" }, { id: 'm', title: "Assédio Processual", description: "Ajuizamento de ações com o objetivo de dificultar os direitos da parte contrária.", cpc: "art. 80, III e V, CPC" }, { id: 'd', title: "Foro Inadequado (Forum Shopping)", description: "Ajuizamento de ações em comarcas distantes do domicílio das partes.", cpc: "art. 80, III e V, CPC" }, { id: 'k', title: "Ação sem Documentos Essenciais", description: "Ajuizamento de ações sem documentos essenciais.", cpc: "art. 80, I, V e VI, CPC" } ];
        
        // --- COMPONENTE PRINCIPAL (APP) ---
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(currentUser => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => {
                auth.signOut().catch(error => console.error("Erro ao sair:", error));
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-indigo-500"></div>
                    </div>
                );
            }

            if (!user) return <AuthPage />;
            
            if (user && !user.emailVerified && user.providerData.some(p => p.providerId === 'password')) {
                return <EmailVerificationPage user={user} onLogout={handleLogout} />;
            }
            
            return <MainLayout user={user} onLogout={handleLogout} />;
        };
        
        // --- COMPONENTES DE AUTENTICAÇÃO (sem alterações) ---
        const AuthPage = () => {
            const [authAction, setAuthAction] = React.useState('login'); 
            const renderForm = () => {
                switch(authAction) {
                    case 'login': return <LoginForm onResetPassword={() => setAuthAction('reset')} />;
                    case 'register': return <RegisterForm onSwitchToLogin={() => setAuthAction('login')} />;
                    case 'reset': return <ResetPasswordForm onSwitchToLogin={() => setAuthAction('login')} />;
                    default: return <LoginForm onResetPassword={() => setAuthAction('reset')} />;
                }
            };
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 font-sans">
                    <div className="w-full max-w-md p-4 md:p-8 space-y-6 bg-white rounded-lg shadow-xl">
                        <div className="text-center"><img src="https://dev-caw.github.io/combate-litigancia-abusiva/img/topo.png" alt="Logotipo CAW" /></div>
                        {renderForm()}
                        {authAction !== 'reset' && (
                            <div className="text-center text-sm">
                                <a href="#" className="font-medium text-indigo-600 hover:text-indigo-500" onClick={(e) => { e.preventDefault(); setAuthAction(authAction === 'login' ? 'register' : 'login'); }}>
                                    {authAction === 'login' ? "Não tem uma conta? Cadastre-se" : "Já tem uma conta? Faça o login"}
                                </a>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const EmailVerificationPage = ({ user, onLogout }) => {
            const [message, setMessage] = React.useState('');
            const handleResendVerification = () => {
                user.sendEmailVerification()
                    .then(() => setMessage('Um novo e-mail de verificação foi enviado.'))
                    .catch(error => setMessage(`Erro: ${translateFirebaseAuthError(error.code)}`));
            };
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 font-sans">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-xl text-center">
                        <h2 className="text-2xl font-bold text-gray-800">Verifique seu E-mail</h2>
                        <p className="text-gray-600">Um link de verificação foi enviado para <strong>{user.email}</strong>. Por favor, clique no link para ativar sua conta.</p>
                        <p className="text-gray-500 text-sm">Se não encontrar o e-mail, verifique sua pasta de spam. Você precisa verificar seu e-mail para continuar.</p>
                        <button onClick={handleResendVerification} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Reenviar E-mail de Verificação</button>
                        {message && <p className="text-green-600 text-sm mt-2">{message}</p>}
                         <button onClick={() => window.location.reload()} className="mt-4 w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Já verifiquei. Continuar.</button>
                        <button onClick={onLogout} className="mt-2 text-sm text-gray-500 hover:text-gray-700">Sair</button>
                    </div>
                </div>
            );
        };
        const translateFirebaseAuthError = (code) => {
            switch (code) {
                case 'auth/invalid-email': return 'O formato do e-mail é inválido.';
                case 'auth/user-disabled': return 'Este usuário foi desabilitado.';
                case 'auth/user-not-found': return 'Nenhum usuário encontrado com este e-mail.';
                case 'auth/wrong-password': return 'Senha incorreta. Tente novamente.';
                case 'auth/email-already-in-use': return 'Este e-mail já está em uso por outra conta.';
                case 'auth/weak-password': return 'A senha é muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/popup-closed-by-user': return 'A janela de login foi fechada antes da conclusão. Tente novamente.';
                case 'auth/popup-blocked': return 'A janela de login foi bloqueada pelo navegador. Por favor, permita pop-ups para este site.';
                case 'auth/operation-not-allowed': return 'O login com Google não está habilitado. Verifique as configurações do Firebase.';
                case 'auth/unauthorized-domain': return 'Este domínio não está autorizado para operações de login. Verifique as configurações do Firebase.';
                default: return `Ocorreu um erro inesperado (${code}). Por favor, tente novamente.`;
            }
        };
        const LoginForm = ({ onResetPassword }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                auth.signInWithEmailAndPassword(email, password)
                    .catch(err => setError(translateFirebaseAuthError(err.code)))
                    .finally(() => setLoading(false));
            };

            const handleGoogleLogin = () => {
                setError('');
                auth.signInWithPopup(googleProvider)
                    .catch(err => setError(translateFirebaseAuthError(err.code)));
            };

            return (
                <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                    <input type="email" required className="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endereço de e-mail" value={email} onChange={(e) => setEmail(e.target.value)} />
                    <input type="password" required className="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha" value={password} onChange={(e) => setPassword(e.target.value)} />
                    <div className="text-right text-sm"> <a href="#" onClick={(e) => { e.preventDefault(); onResetPassword(); }} className="font-medium text-indigo-600 hover:text-indigo-500"> Esqueceu sua senha? </a> </div>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                    <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400">
                        {loading ? 'Entrando...' : 'Entrar'}
                    </button>
                    <div className="relative flex py-2 items-center"><div className="flex-grow border-t border-gray-300"></div><span className="flex-shrink mx-4 text-gray-400 text-sm">OU</span><div className="flex-grow border-t border-gray-300"></div></div>
                    <button type="button" onClick={handleGoogleLogin} className="w-full flex justify-center items-center gap-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <GoogleIcon/> Entrar com Google
                    </button>
                </form>
            );
        };
        const RegisterForm = ({ onSwitchToLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [success, setSuccess] = React.useState(false);

            const handleRegister = (e) => {
                e.preventDefault();
                if (password !== confirmPassword) {
                    setError('As senhas não coincidem.');
                    return;
                }
                setError('');
                setLoading(true);
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        userCredential.user.sendEmailVerification();
                        setSuccess(true);
                    })
                    .catch(err => setError(translateFirebaseAuthError(err.code)))
                    .finally(() => setLoading(false));
            };

            if (success) {
                return <div className="text-center text-green-700 bg-green-50 p-4 rounded-md">
                    <h3 className="font-bold">Cadastro realizado com sucesso!</h3>
                    <p className="text-sm mt-2">Um e-mail de verificação foi enviado para <strong>{email}</strong>. Por favor, verifique sua caixa de entrada e clique no link para ativar sua conta.</p>
                     <button onClick={onSwitchToLogin} className="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">Voltar para o Login</button>
                </div>
            }

            return (
                 <form className="mt-8 space-y-4" onSubmit={handleRegister}>
                    <input type="email" required className="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu melhor e-mail" value={email} onChange={(e) => setEmail(e.target.value)} />
                    <input type="password" required className="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Crie uma senha (mín. 6 caracteres)" value={password} onChange={(e) => setPassword(e.target.value)} />
                    <input type="password" required className="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Confirme sua senha" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                    <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400">
                        {loading ? 'Cadastrando...' : 'Criar Conta'}
                    </button>
                </form>
            );
        };
        const ResetPasswordForm = ({ onSwitchToLogin }) => {
            const [email, setEmail] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [success, setSuccess] = React.useState(false);

            const handleReset = (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                auth.sendPasswordResetEmail(email)
                    .then(() => setSuccess(true))
                    .catch(err => setError(translateFirebaseAuthError(err.code)))
                    .finally(() => setLoading(false));
            };

            if (success) {
                 return <div className="text-center text-green-700 bg-green-50 p-4 rounded-md">
                    <h3 className="font-bold">E-mail enviado!</h3>
                    <p className="text-sm mt-2">Se houver uma conta associada a <strong>{email}</strong>, você receberá um link para redefinir sua senha.</p>
                    <button onClick={onSwitchToLogin} className="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">Voltar para o Login</button>
                </div>
            }

            return (
                 <form className="mt-8 space-y-4" onSubmit={handleReset}>
                     <h3 className="text-center text-xl font-semibold text-gray-800">Redefinir Senha</h3>
                    <p className="text-center text-sm text-gray-600">Insira seu e-mail para receber um link de redefinição de senha.</p>
                    <input type="email" required className="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endereço de e-mail" value={email} onChange={(e) => setEmail(e.target.value)} />
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                    <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400">
                        {loading ? 'Enviando...' : 'Enviar Link de Redefinição'}
                    </button>
                    <div className="text-center text-sm">
                        <a href="#" className="font-medium text-indigo-600 hover:text-indigo-500" onClick={(e) => { e.preventDefault(); onSwitchToLogin(); }}>
                             Voltar para o Login
                        </a>
                    </div>
                </form>
            )
        }

        // --- COMPONENTES AUXILIARES ---
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const GeminiResponseRenderer = ({ responseText, isDirect = false }) => {
            if (!responseText) return null;
            let processedText = responseText;
            if (isDirect) {
                processedText = responseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            } else {
                processedText = responseText
                    .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^- (.*?)(?:\n|$)/gm, (match, p1) => `<li class="text-gray-700 ml-4">${p1.trim()}</li>`)
                    .replace(/(<li>.*?<\/li>)/g, '<ul class="list-disc list-inside">$1</ul>');
            }
            processedText = processedText.replace(/\n/g, '<br />').replace(/(<br\s*\/?>\s*){3,}/g, '<br /><br />').replace(/<\/ul><br \/><ul>/g, '');

            return <div className={`space-y-4 text-gray-700 ${isDirect ? 'gemini-response-direct' : 'gemini-response'}`} dangerouslySetInnerHTML={{ __html: processedText }}></div>;
        };
        
        const CaseSelector = ({ cases, selectedCaseId, onSelectCase, title = "Selecione o Caso" }) => (
            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 className="block text-xl font-semibold text-gray-700 mb-4">{title}</h3>
                <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                    {cases.map(c => (
                        <label key={c.id} className={`flex items-center p-3 border rounded-lg cursor-pointer transition-all ${selectedCaseId === c.id.toString() ? 'bg-indigo-100 border-indigo-500 shadow' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                            <input 
                                type="radio"
                                name="case-selection"
                                value={c.id}
                                checked={selectedCaseId === c.id.toString()}
                                onChange={e => onSelectCase(e.target.value)}
                                className="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                            />
                            <span className="ml-3 text-sm font-medium text-gray-800">
                                {c.caseNumber} - {c.client.toUpperCase()} vs {c.defendant.toUpperCase()}
                            </span>
                        </label>
                    ))}
                </div>
            </div>
        );
        
        // --- MÓDULOS DA APLICAÇÃO ---
        const Sidebar = ({ activeModule, onSelectModule, onLogout, isSidebarOpen, isSidebarCollapsed, toggleSidebarCollapse, fraudAlert, closeSidebar, analysisModuleClickedFirstTime }) => {
            return (
                <aside className={`bg-gray-800 text-gray-100 flex flex-col fixed lg:static inset-y-0 left-0 z-50 transition-all duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 ${isSidebarCollapsed ? 'w-20' : 'w-64'}`}>
                    <div className="flex items-center justify-between h-20 border-b border-gray-700 px-4">
                        <div className={`transition-all duration-300 ${isSidebarCollapsed ? 'opacity-0 scale-0' : 'opacity-100 scale-100'}`}>
                            {!isSidebarCollapsed && <img src="https://dev-caw.github.io/combate-litigancia-abusiva/img/logo-white.png" alt="logotipo-branco" className="h-10" />}
                        </div>
                        <button onClick={closeSidebar} className="lg:hidden text-gray-400 hover:text-white"><CloseIcon /></button>
                    </div>
                    <nav className="flex-1 px-2 py-4 space-y-2 overflow-y-auto">
                        {modules.map((module) => {
                            const isFraudModule = module.id === 'DetecçãoDeFraudes';
                            const isAnalysisModule = module.id === 'AnáliseDeDados';
                            const isActive = activeModule === module.id;
                            
                            let customClass = 'hover:bg-gray-700';
                            if (isActive) {
                                customClass = 'bg-indigo-600';
                            } else if (isFraudModule && fraudAlert) {
                                customClass = 'bg-red-600 animate-pulse';
                            } else if (isAnalysisModule && !analysisModuleClickedFirstTime) {
                                customClass += ' animate-pulse-green';
                            }

                            return (
                                <a key={module.id} href="#" onClick={(e) => { e.preventDefault(); onSelectModule(module.id); if(window.innerWidth < 1024) closeSidebar(); }} className={`flex items-center p-2 text-base font-normal rounded-lg transition-colors ${customClass} ${isSidebarCollapsed ? 'justify-center' : ''}`}>
                                    <module.icon />
                                    <span className={`ml-3 transition-opacity duration-200 ${isSidebarCollapsed ? 'hidden' : 'block'}`}>{module.name}</span>
                                </a>
                            );
                        })}
                    </nav>
                    <div className="px-2 py-4 mt-auto border-t border-gray-700">
                        <button onClick={toggleSidebarCollapse} className="hidden lg:flex items-center justify-center w-full p-2 text-base font-normal rounded-lg hover:bg-gray-700 transition-colors">
                           {isSidebarCollapsed ? <ArrowRightOnRectangleIcon /> : <ArrowLeftOnRectangleIcon />}
                        </button>
                         <a href="#" onClick={onLogout} className={`flex items-center p-2 text-base font-normal rounded-lg hover:bg-gray-700 transition-colors mt-2 ${isSidebarCollapsed ? 'justify-center' : ''}`}>
                            <LogoutIcon />
                            <span className={`ml-3 transition-opacity duration-200 ${isSidebarCollapsed ? 'hidden' : 'block'}`}>Sair</span>
                        </a>
                    </div>
                </aside>
            );
        };
        const Dashboard = ({ onSelectModule, analysisModuleClickedFirstTime }) => (
            <div>
                <img src="https://dev-caw.github.io/combate-litigancia-abusiva/img/combate.png" alt="Banner Combate à Litigância Abusiva" style={{ padding: '20px 25%' }} />
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {modules.filter(m => m.id !== 'Dashboard').map((module) => (
                        <div key={module.id} className="relative bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer flex flex-col items-center text-center" onClick={() => onSelectModule(module.id)}>
                            {module.id === 'AnáliseDeDados' && !analysisModuleClickedFirstTime && (
                                <span className="absolute top-0 right-0 -mt-2 -mr-2 px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full shadow-lg">Comece por aqui</span>
                            )}
                            <div className="text-indigo-600 mb-4"> <module.icon /> </div>
                            <h3 className="text-lg font-semibold text-gray-700">{module.name}</h3>
                        </div>
                    ))}
                </div>
            </div>
        );
        const OverviewModule = ({ casesData }) => {
            const [selectedCase, setSelectedCase] = React.useState(null);
            const totalValue = casesData.reduce((acc, c) => acc + c.value, 0);
            const highRiskCases = casesData.filter(c => c.riskLevel === 'Alto' || c.riskLevel === 'Crítico').length;
            const getRiskColor = (level) => {
                switch (level) {
                    case 'Crítico': return 'bg-red-200 text-red-800';
                    case 'Alto': return 'bg-yellow-200 text-yellow-800';
                    case 'Médio': return 'bg-blue-200 text-blue-800';
                    case 'Baixo': return 'bg-green-200 text-green-800';
                    default: return 'bg-gray-200 text-gray-800';
                }
            };
            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-6">Overview</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div className="bg-white p-5 rounded-lg shadow-md"><h4 className="text-gray-500 text-sm font-medium">TOTAL DE CASOS</h4><p className="text-3xl font-bold text-gray-800">{casesData.length}</p></div>
                        <div className="bg-white p-5 rounded-lg shadow-md"><h4 className="text-gray-500 text-sm font-medium">RISCO ALTO/CRÍTICO</h4><p className="text-3xl font-bold text-red-600">{highRiskCases}</p></div>
                        <div className="bg-white p-5 rounded-lg shadow-md"><h4 className="text-gray-500 text-sm font-medium">VALOR TOTAL DAS CAUSAS</h4><p className="text-3xl font-bold text-gray-800">{totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                    </div>
                    <div className="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº do Processo</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parte Adversa</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nível de Risco</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {casesData.map((c) => (
                                    <tr key={c.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => setSelectedCase(c)}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{c.caseNumber}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 uppercase">{c.client}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 uppercase">{c.defendant}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{c.status}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskColor(c.riskLevel)}`}>{c.riskLevel}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {selectedCase && (<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center" onClick={() => setSelectedCase(null)}><div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4" onClick={e => e.stopPropagation()}><div className="p-6"><div className="flex justify-between items-start"><div><h3 className="text-xl md:text-2xl font-bold text-gray-900">{selectedCase.subject}</h3><p className="text-sm text-gray-500 mt-1">{selectedCase.caseNumber}</p></div><button onClick={() => setSelectedCase(null)} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button></div><div className="mt-4 border-t pt-4"><h4 className="font-semibold text-gray-800 mb-3">Resumo do Caso</h4><p className="text-gray-700 text-sm mb-4">{selectedCase.details.summary}</p><h4 className="font-semibold text-gray-800 mb-3">Indicadores de Abuso Identificados</h4><ul className="list-disc list-inside space-y-2 mb-4">{selectedCase.details.indicators.map((indicator, index) => (<li key={index} className="text-sm text-yellow-800 bg-yellow-50 p-2 rounded-md">{indicator}</li>))}</ul><h4 className="font-semibold text-gray-800 mb-3">Documentos Relevantes</h4><div className="flex flex-wrap gap-2">{selectedCase.details.documents.map((doc, index) => (<span key={index} className="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">{doc}</span>))}</div></div></div></div></div>)}
                </div>
            );
        };
        const AnaliseDeDadosIAModule = ({ onAnalysisComplete, onAddNewCase }) => {
            const [newCaseData, setNewCaseData] = React.useState({ caseNumber: '', client: '', defendant: '', numJuizo: '', nomeJuizo: 'JUIZADO ESPECIAL CÍVEL', comarca: '', uf: 'RJ' });
            const [caseText, setCaseText] = React.useState('Reclamante alega horas extras não pagas, mas a empresa possui um sistema de ponto biométrico que foi verificado em inspeção judicial e considerado regular. O advogado do reclamante possui outras 50 ações idênticas contra a mesma empresa, com as mesmas alegações. Há risco de fraude e litigância predatória.');
            const [isAnalyzing, setIsAnalyzing] = React.useState(false);
            const [analysisResult, setAnalysisResult] = React.useState('');
            const [error, setError] = React.useState('');
            
            const UFs = ["AC", "AL", "AP", "AM", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", "SP", "SE", "TO"];
            const nomesJuizo = ["JUIZADO ESPECIAL CÍVEL", "VARA CÍVEL", "VARA DO TRABALHO"];

            const formatProcessNumber = (value) => {
                const cleaned = value.replace(/\D/g, '');
                const match = cleaned.match(/^(\d{0,7})(\d{0,2})(\d{0,4})(\d{0,1})(\d{0,2})(\d{0,4})$/);
                if (!match) return value;
                return `${match[1]}${match[2] ? '-' + match[2] : ''}${match[3] ? '.' + match[3] : ''}${match[4] ? '.' + match[4] : ''}${match[5] ? '.' + match[5] : ''}${match[6] ? '.' + match[6] : ''}`;
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (name === "caseNumber") {
                    setNewCaseData(prev => ({ ...prev, [name]: formatProcessNumber(value) }));
                } else if (name === "numJuizo") {
                     setNewCaseData(prev => ({ ...prev, [name]: value.replace(/\D/g, '') }));
                }
                else {
                    setNewCaseData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleAnalyzeWithAI = async () => { 
                if (!caseText.trim() || Object.values(newCaseData).some(x => x === '')) {
                     setError("Por favor, preencha todos os campos de identificação e descrição do caso.");
                     return;
                }
                setError('');
                if (!GEMINI_API_KEY || !GEMINI_API_KEY.startsWith("AIzaSy")) {
                    setAnalysisResult("Erro: A chave da API do Gemini não foi configurada corretamente.");
                    return;
                }
                setIsAnalyzing(true); 
                setAnalysisResult(''); 
                let text = ''; 
                const prompt = `Aja como um advogado sênior e estrategista. Analise o seguinte relato de um caso jurídico. Forneça uma resposta estruturada usando a formatação "### Título" para os cabeçalhos e "- " para listas. A resposta deve conter EXATAMENTE os seguintes cabeçalhos:\n### Resumo do Caso\n### Pontos de Atenção e Riscos\n### Sugestão de Estratégia\n\nTexto do caso para análise:\n---\n${caseText}\n---`; 
                try { 
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] }; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`; 
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); 
                    const result = await response.json(); 
                    text = result.candidates?.[0]?.content?.parts?.[0]?.text || ''; 
                    if (text) { 
                        setAnalysisResult(text); 
                        onAddNewCase({
                            ...newCaseData,
                            id: Date.now(),
                            subject: "Novo Caso Analisado",
                            status: "Em Análise",
                            riskLevel: text.toLowerCase().includes('crítico') ? 'Crítico' : (text.toLowerCase().includes('alto') ? 'Alto' : 'Médio'),
                            value: 0,
                            details: {
                                summary: caseText, // Usar o texto inserido pelo usuário como resumo
                                indicators: text.split('###')[2]?.replace('Pontos de Atenção e Riscos', '').match(/- (.*)/g)?.map(i => i.substring(2)) || [],
                                documents: []
                            }
                        });
                        if (text.toLowerCase().includes('risco') || text.toLowerCase().includes('fraude') || text.toLowerCase().includes('abusiva') || text.toLowerCase().includes('predatória')) { 
                            onAnalysisComplete(true); 
                        }
                    } else { 
                        setAnalysisResult("Erro: A resposta da IA estava em um formato inesperado."); 
                    } 
                } catch (error) { 
                    console.error("Erro ao chamar a API do Gemini:", error); 
                    setAnalysisResult("Ocorreu um erro ao gerar a análise. Tente novamente."); 
                } finally { 
                    setIsAnalyzing(false);
                } 
            };

            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-2">Análise de Dados</h2>
                    <p className="text-gray-600 mb-6">Descreva os fatos do caso concreto e obtenha um resumo analítico, com a identificação dos riscos e sugestões de estratégias.</p>
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 className="text-xl font-semibold text-gray-700 mb-4">1. Identifique o Caso</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                           <input name="caseNumber" value={newCaseData.caseNumber} onChange={handleInputChange} placeholder="Nº DO PROCESSO" maxLength="25" className="w-full p-2 border border-gray-300 rounded-md"/>
                           <input name="client" value={newCaseData.client} onChange={handleInputChange} placeholder="CLIENTE" className="w-full p-2 border border-gray-300 rounded-md"/>
                           <input name="defendant" value={newCaseData.defendant} onChange={handleInputChange} placeholder="PARTE ADVERSA" className="w-full p-2 border border-gray-300 rounded-md"/>
                           <input name="numJuizo" value={newCaseData.numJuizo} onChange={handleInputChange} placeholder="Nº DO JUÍZO" className="w-full p-2 border border-gray-300 rounded-md"/>
                            <select name="nomeJuizo" value={newCaseData.nomeJuizo} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded-md bg-white">
                                {nomesJuizo.map(nome => <option key={nome} value={nome}>{nome}</option>)}
                            </select>
                           <input name="comarca" value={newCaseData.comarca} onChange={handleInputChange} placeholder="COMARCA" className="w-full p-2 border border-gray-300 rounded-md"/>
                            <select name="uf" value={newCaseData.uf} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded-md bg-white">
                                {UFs.map(uf => <option key={uf} value={uf}>{uf}</option>)}
                            </select>
                        </div>
                         {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                        <h3 className="text-xl font-semibold text-gray-700 mb-4">2. Descreva o Caso</h3>
                        <textarea value={caseText} onChange={(e) => setCaseText(e.target.value)} placeholder="Cole ou descreva aqui os fatos, petições ou documentos relevantes para a análise..." className="w-full h-40 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        <button onClick={handleAnalyzeWithAI} disabled={isAnalyzing} className="mt-4 w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300">
                            <SparkleIcon /> {isAnalyzing ? 'Analisando...' : 'Analisar e Cadastrar Caso'}
                        </button>
                    </div>
                    {(isAnalyzing || analysisResult) && (
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h3 className="text-xl font-semibold text-gray-700 mb-4">3. Análise Estratégica da IA</h3>
                            {isAnalyzing ? <p className="text-indigo-700">Aguarde, a IA está processando sua solicitação...</p> : <GeminiResponseRenderer responseText={analysisResult} />}
                        </div>
                    )}
                </div>
            );
        };
        const DeteccaoDeFraudesModule = ({ casesData }) => {
            const [selectedCaseId, setSelectedCaseId] = React.useState('');
            const [isScanning, setIsScanning] = React.useState(false);
            const [scanResults, setScanResults] = React.useState([]);

            const handleScan = () => {
                if (!selectedCaseId) {
                    alert("Por favor, selecione um caso para analisar.");
                    return;
                }
                setIsScanning(true);
                setScanResults([]);
                setTimeout(() => {
                    const selectedCase = casesData.find(c => c.id.toString() === selectedCaseId);
                    const results = {};
                    if (!selectedCase) {
                        setIsScanning(false);
                        return;
                    }
                    
                    if (selectedCase.details.indicators.some(ind => ind.toLowerCase().includes("concentração de grande volume") || ind.toLowerCase().includes("ações idênticas"))) {
                        if(!results['l']) results['l'] = { indicator: cnjIndicators.find(i => i.id === 'l'), cases: []};
                        results['l'].cases.push(selectedCase);
                    }
                    if (selectedCase.details.indicators.some(ind => ind.toLowerCase().includes("petições genéricas") || ind.toLowerCase().includes("causas de pedir idênticas"))) {
                        if(!results['g']) results['g'] = { indicator: cnjIndicators.find(i => i.id === 'g'), cases: []};
                        results['g'].cases.push(selectedCase);
                    }
                    if (selectedCase.details.indicators.some(ind => ind.toLowerCase().includes("assédio processual"))) {
                         if(!results['m']) results['m'] = { indicator: cnjIndicators.find(i => i.id === 'm'), cases: []};
                         results['m'].cases.push(selectedCase);
                    }
                    
                    setScanResults(Object.values(results));
                    setIsScanning(false);
                }, 1500);
            };

            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-2">Detecção de Fraudes</h2>
                    <p className="text-gray-600 mb-6">Selecione um caso e inicie uma varredura para identificar padrões de conduta abusiva, com base na Recomendação 159/2024 do CNJ.</p>
                    <CaseSelector cases={casesData} selectedCaseId={selectedCaseId} onSelectCase={setSelectedCaseId} />
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <button onClick={handleScan} disabled={isScanning || !selectedCaseId} className="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 disabled:bg-red-300 transition-colors">
                            <SearchIcon/>
                            {isScanning ? 'Analisando Caso...' : 'Analisar Caso Selecionado'}
                        </button>
                    </div>
                    {isScanning && ( <div className="text-center p-6 bg-white rounded-lg shadow-md"> <p className="text-red-700 font-semibold animate-pulse">Analisando caso em busca de padrões...</p> </div> )}
                    {!isScanning && scanResults.length === 0 && ( <div className="text-center p-6 bg-white rounded-lg shadow-md"> <p className="text-gray-500">Nenhum padrão de fraude detectado no caso selecionado ou a varredura não foi iniciada.</p> </div> )}
                    {scanResults.length > 0 && (
                        <div className="space-y-6">
                            <h3 className="text-2xl font-semibold text-gray-800">Resultados da Varredura</h3>
                            {scanResults.map(({indicator, cases}) => (
                                <div key={indicator.id} className="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
                                    <h4 className="text-xl font-bold text-red-700">{indicator.title}</h4>
                                    <p className="text-gray-600 mt-1">{indicator.description}</p>
                                    <p className="text-xs text-gray-500 mt-1">Enquadramento: {indicator.cpc}</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        const VerificacaoDeDocsModule = ({ casesData }) => {
            const [activeTab, setActiveTab] = React.useState('analiseBoleto');
            const [selectedCaseId, setSelectedCaseId] = React.useState('');
            const tabs = [
                { id: 'analiseBoleto', label: 'Análise de Documentos' },
                { id: 'validacaoAssinatura', label: 'Validação de Assinatura Digital' },
                { id: 'geolocalizacao', label: 'Análise de Geolocalização' }
            ];

            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-6">Verificação de Documentos</h2>
                     <CaseSelector cases={casesData} selectedCaseId={selectedCaseId} onSelectCase={setSelectedCaseId} />
                    <div className="border-b border-gray-200">
                        <nav className="-mb-px flex flex-wrap -mx-4" aria-label="Tabs">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`${
                                        activeTab === tab.id
                                            ? 'border-indigo-500 text-indigo-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    } whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-colors`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </nav>
                    </div>
                    <div className="mt-6 bg-white p-6 rounded-lg shadow-md">
                        {activeTab === 'analiseBoleto' && <AnaliseBoletoSubModule />}
                        {activeTab === 'validacaoAssinatura' && <ValidacaoAssinaturaSubModule />}
                        {activeTab === 'geolocalizacao' && <GeolocalizacaoSubModule />}
                    </div>
                </div>
            );
        };
        const AutomacaoDeDefesaModule = ({ casesData }) => {
            const allTeses = [ { id: 'normas', title: "Observância das normas contratuais e regulatórias" }, { id: 'tecnica', title: "Fundamentação técnica das decisões" }, { id: 'coletivos', title: "Natureza dos contratos coletivos" }, { id: 'ausencia_prova', title: "Ausência de prova de irregularidade" }, { id: 'contestacao_urgencia', title: "Contestação da urgência alegada" }, { id: 'deferencia_ans', title: "Deferência à Agência Reguladora (ANS)" }, { id: 'impacto_decisoes', title: "Análise de Impacto das Decisões (LINDB/AED)" }, { id: 'ilegitimidade_passiva', title: "Ilegitimidade Passiva" }, { id: 'dialeticidade', title: "Dialeticidade Recursal" }, { id: 'impugnacao_vulnerabilidade', title: "Impugnação à Vulnerabilidade Técnica ou Informacional" }, { id: 'indeferimento_tutela', title: "Indeferimento da tutela de urgência" }, { id: 'producao_provas', title: "Produção de provas" }, { id: 'juntada_docs', title: "Juntada de documentos pela parte autora" }, { id: 'ma_fe', title: "Identificação e punição da litigância de má-fé" }, { id: 'segredo_justica', title: "Indeferimento do pedido de segredo de justiça" }, { id: 'indeferimento_total', title: "Indeferimento total dos pleitos" }, { id: 'custas_honorarios', title: "Condenação em custas e honorários sucumbenciais" }, ].sort((a, b) => a.title.localeCompare(b.title));
            const [selectedCaseId, setSelectedCaseId] = React.useState('');
            const [caseContext, setCaseContext] = React.useState("");
            const [selectedTeses, setSelectedTeses] = React.useState([]);
            const [isGenerating, setIsGenerating] = React.useState(false);
            const [generatedText, setGeneratedText] = React.useState('');
            const [error, setError] = React.useState('');

            React.useEffect(() => {
                if (selectedCaseId) {
                    const selectedCase = casesData.find(c => c.id.toString() === selectedCaseId);
                    setCaseContext(selectedCase ? selectedCase.details.summary : "");
                } else {
                    setCaseContext("");
                }
            }, [selectedCaseId, casesData]);

            const handleTeseSelection = (teseId) => {
                setSelectedTeses(prev => prev.includes(teseId) ? prev.filter(id => id !== teseId) : [...prev, teseId]);
            };

            const handleGenerate = async () => {
                if (!caseContext.trim() || selectedTeses.length === 0) {
                    setError("É necessário ter um contexto de caso e selecionar ao menos uma tese.");
                    return;
                }
                 if (!GEMINI_API_KEY || !GEMINI_API_KEY.startsWith("AIzaSy")) {
                     setError("Erro: A chave da API do Gemini não foi configurada corretamente.");
                    return;
                }
                setError('');
                setIsGenerating(true);
                setGeneratedText('');
                const selectedTesesTitles = selectedTeses.map(id => allTeses.find(t => t.id === id).title).join('", "');
                try {
                    const prompt = `Aja como um advogado especialista. Dado o contexto do caso abaixo, redija uma argumentação jurídica para contestação ou recurso, focada especificamente na(s) seguinte(s) tese(s): "${selectedTesesTitles}".\n\n**Contexto do Caso:**\n${caseContext}\n\nA resposta deve começar diretamente com a argumentação, usando o título de cada tese como um cabeçalho em negrito (usando **Título da Tese**) para separar as seções. Não adicione nenhum preâmbulo, introdução ou conclusão.`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("Erro da API:", errorBody);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                        const text = result.candidates[0].content.parts[0].text;
                        setGeneratedText(text);
                    } else {
                        console.error("Resposta da API em formato inesperado:", result);
                        setGeneratedText("Não foi possível gerar a argumentação. A resposta da IA estava vazia ou em formato incorreto.");
                    }
                } catch (error) {
                    console.error("Erro ao gerar tese:", error);
                    setGeneratedText("Ocorreu um erro ao gerar a argumentação. Tente novamente.");
                } finally {
                    setIsGenerating(false);
                }
            };
            
            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-2">Automação de Defesa</h2>
                    <p className="text-gray-600 mb-6">Selecione o caso para carregar as informações, escolha uma ou mais teses e receba a proposta de argumentação jurídica.</p>
                    <CaseSelector cases={casesData} selectedCaseId={selectedCaseId} onSelectCase={setSelectedCaseId} />

                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 className="text-xl font-semibold text-gray-700 mb-4">2. Selecione as Teses para Desenvolver</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            {allTeses.map(tese => (
                                <div key={tese.id} className="flex items-start">
                                    <input id={`tese-${tese.id}`} type="checkbox" checked={selectedTeses.includes(tese.id)} onChange={() => handleTeseSelection(tese.id)} className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mt-1" />
                                    <label htmlFor={`tese-${tese.id}`} className="ml-3 text-sm text-gray-700">{tese.title}</label>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                         <button onClick={handleGenerate} disabled={isGenerating || selectedTeses.length === 0 || !caseContext.trim()} className="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed">
                            <SparkleIcon />
                            {isGenerating ? "Gerando..." : "Gerar Argumentação com IA"}
                        </button>
                         {error && <p className="text-red-500 text-sm mt-4">{error}</p>}
                    </div>
                    
                    {(isGenerating || generatedText) && (
                        <div className="bg-white p-6 rounded-lg shadow-md">
                             <h3 className="text-xl font-semibold text-gray-700 mb-4">3. Argumentação Gerada pela IA</h3>
                             {isGenerating 
                                ? <p className="text-indigo-700">Gerando argumentação... Por favor, aguarde.</p> 
                                : <div className="bg-gray-50 p-4 rounded-md border">
                                   <GeminiResponseRenderer responseText={generatedText} isDirect={true} />
                                  </div>
                              }
                        </div>
                    )}
                </div>
            );
        };
        const AntiDesistenciaModule = ({ casesData }) => {
            const [selectedCaseId, setSelectedCaseId] = React.useState('');
            
            const generateDocx = () => {
                const selectedCase = casesData.find(c => c.id.toString() === selectedCaseId);
                if (!selectedCase) {
                    alert("Por favor, selecione um caso para gerar os embargos.");
                    return;
                }

                const { Paragraph, TextRun, Document, AlignmentType } = docx;
                
                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({ text: `JUÍZADO ESPECIAL CÍVEL DA COMARCA DE ${selectedCase.comarca.toUpperCase()}`, style: "default" }),
                            new Paragraph({ text: `Processo: ${selectedCase.caseNumber}`, style: "default" }),
                            new Paragraph({ text: "\n" }),
                            new Paragraph({
                                children: [
                                    new TextRun({ text: selectedCase.client.toUpperCase(), bold: true }),
                                    new TextRun({ text: ", parte ré nestes autos, vem, por seu advogado, tendo em vista omissão na respeitável sentença, que, diante da desistência da ação pela parte autora, extinguiu o processo sem resolução do mérito, opor contra ela os presentes", }),
                                ],
                            }),
                            new Paragraph({ text: "\n" }),
                            new Paragraph({ text: "EMBARGOS DE DECLARAÇÃO,", alignment: AlignmentType.CENTER, style: "strong" }),
                             new Paragraph({ text: "\n" }),
                            new Paragraph({ text: "o que faz com fundamento nos artigos 1.022 e seguinte do Código de Processo Civil, e no Enunciado Cível número 90, do FONAJE.", style: "justify", indentation: { firstLine: 720 } }),
                            new Paragraph({ text: "A embargante, assim como várias outras empresas de grande porte, enfrenta um grande volume de ações artificiais.", style: "justify", indentation: { firstLine: 720 } }),
                            new Paragraph({ text: "Com o objetivo de aprimorar a gestão de demandas repetitivas e ações de massa, o Supremo Tribunal Federal (STF) e o CNJ criaram unidades para melhor acompanhamento e controle dessas demandas.", style: "justify", indentation: { firstLine: 720 } }),
                             new Paragraph({ text: `O que se tem visto, em boa quantidade, é a simples desistência da ação quando se verifica que o réu (${selectedCase.client}) bloqueou com eficiência as alegações autorais, e apresentou prova documental suficiente para aniquilar o direito pleiteado.`, style: "justify", indentation: { firstLine: 720 } }),
                             new Paragraph({ text: `Essas desistências, exercitadas depois de apresentada contestação, devidamente subsidiada por documentos que eliminam a pretensão autoral, é simples má-fé, já que a verdadeira intenção é, uma vez fracassada a estratégia inicial, a de se evitar uma sentença de improcedência, a coisa julgada e a inevitável sanção financeira pela deslealdade processual.`, style: "justify", indentation: { firstLine: 720 } }),
                             new Paragraph({
                                children: [
                                    new TextRun({ text: "Aqui não está a embargante formulando uma resistência ao entendimento sedimentado de que, nos processos regidos pela Lei 9.099, a desistência da ação independe da anuência da parte acionada, embora, data maxima venia, entenda que pudesse fazê-lo, considerando as circunstâncias da desistência, embasada não apenas no artigo 485, § 4º, do Código de Processo Civil, mas também na nova redação do Enunciado Civil número 90 do FONAJE, que assim estabeleceu:", }),
                                ],
                                indentation: { firstLine: 720 },
                                style: "justify",
                            }),
                             new Paragraph({
                                text: `"A desistência da ação, mesmo sem a anuência do réu já citado, implicará a extinção do processo sem resolução do mérito, ainda que tal ato se dê em audiência de instrução e julgamento, salvo quando houver indícios de litigância de má-fé ou lide temerária"`,
                                indentation: { left: 720, right: 720 },
                                style: "quote"
                            }),
                             new Paragraph({ text: "Por tudo isso, o que se busca com esses embargos é a retificação da sentença, que, gerada pelo malicioso pedido de desistência, apenas extinguiu o feito sem considerar a contestação juntada aos autos, acompanhada de todos os documentos que demonstram que a parte autora alterou a verdade dos fatos para tentar alcançar ganho de forma ilegal.", style: "justify", indentation: { firstLine: 720 } }),
                            new Paragraph({ text: `Por esses fundamentos, com ênfase para nova redação do Enunciado Civil número 90 do FONAJE, requer-se recebimento dos presentes embargos, acolhendo-os para, sanando a omissão, conheça do mérito da causa e da má-fé da parte autora, retificando a sentença embargada para julgar improcedentes os pedidos iniciais, impondo à parte autora o pagamento de multa, conforme art. 81 do Código de Processo Civil, mais custas processuais e honorários advocatícios.`, style: "justify", indentation: { firstLine: 720 } }),
                             new Paragraph({ text: "\nNestes termos,", alignment: AlignmentType.CENTER }),
                             new Paragraph({ text: "Pede deferimento.", alignment: AlignmentType.CENTER }),
                             new Paragraph({ text: `\n${selectedCase.comarca}, ${new Date().toLocaleDateString('pt-BR')}.`, alignment: AlignmentType.CENTER }),
                        ],
                    }],
                    styles: {
                        paragraphStyles: [
                            { id: "default", name: "Default", run: { size: 24, font: "Times New Roman" } },
                            { id: "strong", name: "Strong", run: { size: 24, font: "Times New Roman", bold: true } },
                            { id: "quote", name: "Quote", run: { size: 22, font: "Times New Roman", italics: true } },
                            { id: "justify", name: "Justify", alignment: AlignmentType.JUSTIFIED, run: { size: 24, font: "Times New Roman" } },
                        ],
                    },
                });

                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, `Embargos_Declaracao_${selectedCase.caseNumber}.docx`);
                });
            };

            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-2">Anti-Desistência</h2>
                    <p className="text-gray-600 mb-6">Apresente embargos de declaração contra a decisão de extinção do processo por desistência da ação, com fundamento no Enunciado 90 do Fonaje.</p>
                    <CaseSelector cases={casesData} selectedCaseId={selectedCaseId} onSelectCase={setSelectedCaseId} />
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <button onClick={generateDocx} disabled={!selectedCaseId} className="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300">
                            <DownloadIcon /> Gerar Embargos (.DOCX)
                        </button>
                    </div>
                </div>
            );
        };
        const GestaoDeRiscosModule = ({ casesData, riskData }) => {
            const [expandedCaseId, setExpandedCaseId] = React.useState(null);

            const toggleCase = (caseId) => {
                setExpandedCaseId(expandedCaseId === caseId ? null : caseId);
            };

            const getRiskColor = (level) => {
                switch (level) {
                    case 'Alta': return 'border-red-500';
                    case 'Média': return 'border-yellow-400';
                    case 'Baixa': return 'border-green-500';
                    default: return 'border-gray-300';
                }
            };
            
            const RiskMatrix = ({ risks }) => {
                const probabilityLevels = { 'Baixa': 1, 'Média': 2, 'Alta': 3 };
                const impactLevels = { 'Baixo': 1, 'Médio': 2, 'Alto': 3 };
                const probabilityColors = { 'Baixa': 'bg-green-500', 'Média': 'bg-yellow-500', 'Alta': 'bg-red-500'};
                
                return (
                    <div>
                      <h4 className="font-semibold text-gray-800 mb-3">Matriz de Probabilidade e Impacto</h4>
                      <div className="grid grid-cols-4 gap-1 text-center text-xs font-medium">
                          <div className="p-2"></div>
                          <div className="p-2 bg-gray-200 rounded-t-md">Baixo</div>
                          <div className="p-2 bg-gray-200">Médio</div>
                          <div className="p-2 bg-gray-200 rounded-t-md">Alto</div>
                          
                          <div className="p-2 bg-gray-200 rounded-l-md self-center">Alta</div>
                          <div className="relative bg-yellow-200 p-2 h-16 flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 3 && impactLevels[r.impact] === 1).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          <div className="relative bg-red-200 p-2 h-16 flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 3 && impactLevels[r.impact] === 2).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          <div className="relative bg-red-300 p-2 h-16 rounded-tr-md flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 3 && impactLevels[r.impact] === 3).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          
                          <div className="p-2 bg-gray-200 rounded-l-md self-center">Média</div>
                          <div className="relative bg-green-200 p-2 h-16 flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 2 && impactLevels[r.impact] === 1).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          <div className="relative bg-yellow-200 p-2 h-16 flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 2 && impactLevels[r.impact] === 2).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          <div className="relative bg-red-200 p-2 h-16 flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 2 && impactLevels[r.impact] === 3).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          
                          <div className="p-2 bg-gray-200 rounded-bl-md self-center">Baixa</div>
                          <div className="relative bg-green-300 p-2 h-16 rounded-bl-md flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 1 && impactLevels[r.impact] === 1).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          <div className="relative bg-green-200 p-2 h-16 flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 1 && impactLevels[r.impact] === 2).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                          <div className="relative bg-yellow-200 p-2 h-16 rounded-br-md flex items-center justify-center">{risks.filter(r => probabilityLevels[r.probability] === 1 && impactLevels[r.impact] === 3).map((r,i) => <div key={i} title={r.type} className={`w-4 h-4 rounded-full ${probabilityColors[r.probability]} shadow-md`}></div>)}</div>
                      </div>
                    </div>
                )
            };

            return (
                <div>
                    <h2 className="text-3xl font-semibold text-gray-800 mb-6">Gestão de Riscos</h2>
                    <p className="text-gray-600 mb-6">Acesse a análise detalhada dos riscos jurídicos associados a cada caso, com planos de mitigação e visualização de impacto.</p>
                    <div className="space-y-4">
                        {casesData.map(c => {
                            const analysis = riskData[c.id.toString()];
                            const isExpanded = expandedCaseId === c.id;
                            if (!analysis) return null;
                            
                            return (
                                <div key={c.id} className="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300">
                                    <button onClick={() => toggleCase(c.id)} className="w-full text-left p-4 flex justify-between items-center hover:bg-gray-50">
                                        <div>
                                            <p className="font-semibold text-indigo-700">{c.caseNumber}</p>
                                            <p className="text-sm text-gray-600">{c.subject}</p>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className="hidden sm:inline-flex items-center gap-2 text-sm text-gray-700">Riscos Identificados: <span className="font-bold">{analysis.risks.length}</span></span>
                                            <div className={`transform transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                                                <ChevronDownIcon/>
                                            </div>
                                        </div>
                                    </button>
                                    {isExpanded && (
                                        <div className="p-6 border-t border-gray-200 bg-gray-50">
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                                <div className="space-y-4">
                                                    {analysis.risks.map((risk, index) => (
                                                         <div key={index} className={`p-4 rounded-lg border-l-4 ${getRiskColor(risk.probability)} bg-white shadow`}>
                                                            <h4 className="font-bold text-gray-800">{risk.type} (Prob: {risk.probability} / Imp: {risk.impact})</h4>
                                                            <p className="text-sm text-gray-600 mt-1">{risk.description}</p>
                                                            <p className="text-sm text-green-700 mt-2 font-medium"><strong>Plano de Mitigação:</strong> {risk.mitigation}</p>
                                                         </div>
                                                    ))}
                                                </div>
                                                <div>
                                                    <RiskMatrix risks={analysis.risks} />
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        const SituacaoDoExAdversoModule = () => {
             return (
                 <div>
                     <h2 className="text-3xl font-semibold text-gray-800 mb-6">Situação do Ex-Adverso</h2>
                     <div className="bg-white p-8 rounded-lg shadow-md text-center">
                         <p className="text-gray-600 mb-6 max-w-2xl mx-auto">
                             Verifique a situação cadastral de advogados de forma rápida e segura diretamente na fonte oficial da Ordem dos Advogados do Brasil.
                             Clique no botão abaixo para ser redirecionado ao CNA - Cadastro Nacional dos Advogados.
                         </p>
                         <a 
                             href="https://cna.oab.org.br/" 
                             target="_blank" 
                             rel="noopener noreferrer"
                             className="inline-flex items-center justify-center gap-2 px-8 py-4 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-transform hover:scale-105"
                         >
                             Acessar CNA (OAB)
                             <ExternalLinkIcon />
                         </a>
                     </div>
                 </div>
             );
        };
        const CentralDeRelatoriosModule = ({ casesData, riskData }) => {
            const logoUrl = 'https://dev-caw.github.io/combate-litigancia-abusiva/img/caw.png';

            const addHeaderAndFooter = (doc, title) => {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.setTextColor('#111827');
                    doc.text(title, 40, 55);
                    doc.addImage(logoUrl, 'PNG', doc.internal.pageSize.getWidth() - 100, 40, 60, 18);
                    doc.setDrawColor('#e5e7eb');
                    doc.line(40, 75, doc.internal.pageSize.getWidth() - 40, 75);
                    const footerY = doc.internal.pageSize.getHeight() - 40;
                    doc.line(40, footerY, doc.internal.pageSize.getWidth() - 40, footerY);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor('#6b7280');
                    doc.text(`Relatório gerado em: ${new Date().toLocaleString('pt-BR')}`, 40, footerY + 15);
                    doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() - 70, footerY + 15);
                }
            };
            
            const generateRiskReport = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const title = "Relatório Consolidado de Riscos";
                const tableBody = [];
                casesData.forEach(c => {
                    const analysis = riskData[c.id];
                    if (analysis) {
                        analysis.risks.forEach(risk => {
                            tableBody.push([c.caseNumber, risk.type, risk.probability, risk.impact, risk.description, risk.mitigation]);
                        });
                    }
                });
                doc.autoTable({
                    head: [['Caso', 'Tipo de Risco', 'Prob.', 'Impacto', 'Descrição', 'Mitigação']],
                    body: tableBody,
                    startY: 90,
                    theme: 'striped',
                    headStyles: { fillColor: '#1e3a8a', textColor: '#FFFFFF', font: 'helvetica', fontStyle: 'bold' },
                    styles: { font: 'helvetica', fontSize: 9 },
                    columnStyles: { 4: { cellWidth: 150 }, 5: { cellWidth: 150 } }
                });
                addHeaderAndFooter(doc, title);
                doc.save('relatorio_consolidado_riscos.pdf');
            };

            const generateRiskLevelReport = () => {
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF('p', 'pt', 'a4');
                 const title = "Relatório de Casos por Nível de Risco";
                 const tableBody = casesData
                     .sort((a,b) => {
                         const order = { 'Crítico': 0, 'Alto': 1, 'Médio': 2, 'Baixo': 3 };
                         return order[a.riskLevel] - order[b.riskLevel];
                     })
                     .map(c => [
                         c.caseNumber, 
                         c.subject, 
                         c.status, 
                         c.riskLevel,
                         c.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                     ]);
                 doc.autoTable({
                     head: [['Caso', 'Assunto', 'Status', 'Nível de Risco', 'Valor da Causa']],
                     body: tableBody,
                     startY: 90,
                     theme: 'grid',
                     headStyles: { fillColor: '#1e3a8a', textColor: '#FFFFFF', font: 'helvetica', fontStyle: 'bold' },
                     styles: { font: 'helvetica', fontSize: 9 },
                     didParseCell: function (data) {
                         if (data.section === 'body' && data.column.index === 3) {
                             if (data.cell.raw === 'Crítico') { data.cell.styles.textColor = '#991b1b'; data.cell.styles.fontStyle = 'bold'; }
                             if (data.cell.raw === 'Alto') { data.cell.styles.textColor = '#b45309'; data.cell.styles.fontStyle = 'bold'; }
                         }
                     }
                 });
                 addHeaderAndFooter(doc, title);
                 doc.save('relatorio_niveis_de_risco.pdf');
            };

            const generateFraudIndicatorReport = () => {
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF('p', 'pt', 'a4');
                 const title = "Relatório de Indicadores de Fraude";
                 const tableBody = [];
                 const indicatorMap = {};
                 casesData.forEach(c => {
                     c.details.indicators.forEach(indicatorText => {
                         const foundIndicator = cnjIndicators.find(i => indicatorText.toLowerCase().includes(i.title.split(' ')[0].toLowerCase()));
                         const indicatorTitle = foundIndicator ? foundIndicator.title : 'Outros';
                         if (!indicatorMap[indicatorTitle]) indicatorMap[indicatorTitle] = new Set();
                         indicatorMap[indicatorTitle].add(c.caseNumber);
                     });
                 });
                 Object.keys(indicatorMap).forEach(indicator => {
                     tableBody.push([indicator, Array.from(indicatorMap[indicator]).join(', ')]);
                 });
                 doc.autoTable({
                     head: [['Indicador de Fraude (Baseado no CNJ)', 'Casos Associados']],
                     body: tableBody,
                     startY: 90,
                     theme: 'striped',
                     headStyles: { fillColor: '#1e3a8a', textColor: '#FFFFFF', font: 'helvetica', fontStyle: 'bold' },
                     styles: { font: 'helvetica', fontSize: 9 },
                 });
                 addHeaderAndFooter(doc, title);
                 doc.save('relatorio_indicadores_fraude.pdf');
            };

            const ReportButton = ({title, description, onClick}) => (
                <div className="border rounded-lg p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                   <div className="flex flex-col sm:flex-row justify-between sm:items-center">
                       <div className="mb-4 sm:mb-0">
                           <h4 className="font-semibold text-gray-800">{title}</h4>
                           <p className="text-sm text-gray-500 mt-1">{description}</p>
                       </div>
                       <button 
                           onClick={onClick} 
                           className="flex-shrink-0 flex items-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
                       >
                           <DownloadIcon/>
                           Gerar Relatório
                       </button>
                   </div>
                </div>
            );

            return (
                 <div>
                     <h2 className="text-3xl font-semibold text-gray-800 mb-6">Central de Relatórios</h2>
                     <div className="bg-white p-8 rounded-lg shadow-md">
                         <h3 className="text-xl font-semibold text-gray-700 mb-4">Emissão de Relatórios</h3>
                         <p className="text-gray-600 mb-6">Gere relatórios consolidados em formato PDF para análise e apresentação gerencial.</p>
                         <div className="space-y-4">
                            <ReportButton 
                                title="Relatório de Análise de Riscos"
                                description="PDF com todos os riscos, descrições e mitigações identificados."
                                onClick={generateRiskReport}
                             />
                             <ReportButton 
                                title="Relatório de Casos por Nível de Risco"
                                description="Lista todos os casos, ordenados por criticidade, com seus respectivos valores."
                                onClick={generateRiskLevelReport}
                             />
                             <ReportButton 
                                title="Relatório de Indicadores de Fraude"
                                description="Agrupa casos por tipo de indicador de fraude, baseado nas recomendações do CNJ."
                                onClick={generateFraudIndicatorReport}
                             />
                         </div>
                     </div>
                 </div>
            );
        };
        const GenericModulePage = ({ moduleName }) => ( <div> <h2 className="text-3xl font-semibold text-gray-800 mb-6">{moduleName}</h2> <div className="bg-white p-8 rounded-lg shadow-md text-center"> <p className="text-gray-600">O conteúdo para o módulo <span className="font-semibold text-indigo-600">{moduleName}</span> será implementado aqui.</p> </div> </div> );

        // --- COMPONENTE DE LAYOUT PRINCIPAL ---
        const MainLayout = ({ user, onLogout }) => {
            const [casesData, setCasesData] = React.useState(initialCasesData);
            const [riskData, setRiskData] = React.useState(initialRiskAnalysisData);
            const [activeModule, setActiveModule] = React.useState('Dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = React.useState(false);
            const [fraudAlert, setFraudAlert] = React.useState(false);
            const [analysisModuleClickedFirstTime, setAnalysisModuleClickedFirstTime] = React.useState(false);

            const handleSelectModule = (moduleId) => {
                setActiveModule(moduleId);
                if (moduleId === 'DetecçãoDeFraudes') setFraudAlert(false);
                if (moduleId === 'AnáliseDeDados' && !analysisModuleClickedFirstTime) {
                    setAnalysisModuleClickedFirstTime(true);
                }
            };
            
            const handleAddNewCase = (newCase) => {
                setCasesData(prevCases => [...prevCases, newCase]);
                setRiskData(prevRisk => ({
                    ...prevRisk,
                    [newCase.id]: { risks: [{ type: "Inicial", probability: "Média", impact: "Médio", description: "Risco inicial para novo caso, pendente de análise detalhada.", mitigation: "Realizar análise de risco completa." }] }
                }));
                setActiveModule('Overview');
            };
            
            const renderModule = () => {
                switch (activeModule) {
                    case 'Dashboard': return <Dashboard onSelectModule={handleSelectModule} analysisModuleClickedFirstTime={analysisModuleClickedFirstTime} />;
                    case 'Overview': return <OverviewModule casesData={casesData} />;
                    case 'AnáliseDeDados': return <AnaliseDeDadosIAModule onAnalysisComplete={setFraudAlert} onAddNewCase={handleAddNewCase}/>;
                    case 'AutomaçãoDeDefesa': return <AutomacaoDeDefesaModule casesData={casesData} />;
                    case 'AntiDesistencia': return <AntiDesistenciaModule casesData={casesData} />;
                    case 'DetecçãoDeFraudes': return <DeteccaoDeFraudesModule casesData={casesData} />;
                    case 'VerificaçãoDeDocs': return <VerificacaoDeDocsModule casesData={casesData} />;
                    case 'GestãoDeRiscos': return <GestaoDeRiscosModule casesData={casesData} riskData={riskData} />;
                    case 'SituaçãoDoExAdverso': return <SituacaoDoExAdversoModule />;
                    case 'CentralDeRelatorios': return <CentralDeRelatoriosModule casesData={casesData} riskData={riskData} />;
                    default: 
                        const module = modules.find(m => m.id === activeModule);
                        return <GenericModulePage moduleName={module?.name || "Módulo"} />;
                }
            };

            return (
                <div className="relative lg:flex h-screen bg-gray-100 font-sans">
                    <Sidebar 
                        activeModule={activeModule} 
                        onSelectModule={handleSelectModule} 
                        onLogout={onLogout} 
                        isSidebarOpen={isSidebarOpen} 
                        isSidebarCollapsed={isSidebarCollapsed}
                        toggleSidebarCollapse={() => setIsSidebarCollapsed(!isSidebarCollapsed)}
                        fraudAlert={fraudAlert}
                        closeSidebar={() => setIsSidebarOpen(false)}
                        analysisModuleClickedFirstTime={analysisModuleClickedFirstTime}
                       />
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="flex justify-between lg:justify-end items-center p-4 bg-white border-b">
                            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-500 hover:text-gray-700 focus:outline-none lg:hidden">
                                <MenuIcon />
                            </button>
                            <div className="flex items-center space-x-4">
                                <span className="hidden sm:block text-gray-600 text-sm">Bem-vind@, {user.displayName || user.email}</span>
                                <div className="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center">
                                     {user.photoURL ? <img src={user.photoURL} alt="User" className="w-10 h-10 rounded-full" /> : <UserIcon className="text-indigo-600" />}
                                </div>
                            </div>
                        </header>
                        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
                            {renderModule()}
                        </main>
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
